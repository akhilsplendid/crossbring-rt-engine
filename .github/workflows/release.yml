name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y g++ cmake pkg-config
      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_HTTP_SERVER=ON
      - name: Build
        run: cmake --build build --config Release -j
      - name: Package
        run: |
          mkdir -p release/linux
          cp build/rt_engine release/linux/rt_engine
          cp -r configs release/linux/configs
          tar -C release -czf rt-engine-linux-amd64.tar.gz linux
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rt-engine-linux-amd64
          path: rt-engine-linux-amd64.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_HTTP_SERVER=ON
      - name: Build
        run: cmake --build build --config Release -j
      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release\windows | Out-Null
          Copy-Item build\Release\rt_engine.exe release\windows\rt_engine.exe
          Copy-Item configs -Destination release\windows\configs -Recurse
          Compress-Archive -Path release\windows\* -DestinationPath rt-engine-windows-amd64.zip
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rt-engine-windows-amd64
          path: rt-engine-windows-amd64.zip

  gh-release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/rt-engine-linux-amd64/rt-engine-linux-amd64.tar.gz
            dist/rt-engine-windows-amd64/rt-engine-windows-amd64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docker:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Engine image metadata
        id: meta_engine
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/crossbring-rt-engine
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest
      - name: Build and push engine image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta_engine.outputs.tags }}
          labels: ${{ steps.meta_engine.outputs.labels }}
      - name: Bridge image metadata
        id: meta_bridge
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/crossbring-rt-bridge
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest
      - name: Build and push bridge image
        uses: docker/build-push-action@v5
        with:
          context: ./web/bridge
          file: ./web/bridge/Dockerfile
          push: true
          tags: ${{ steps.meta_bridge.outputs.tags }}
          labels: ${{ steps.meta_bridge.outputs.labels }}

